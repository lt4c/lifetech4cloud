{% extends "base.html" %}
{% block title %}Role {{ role.name }}{% endblock %}
{% block content %}
<section>
  <h1>{{ role.name }}</h1>
  <p>{{ role.description or 'No description' }}</p>
  <p><small>Created {{ role.created_at }} - Updated {{ role.updated_at }}</small></p>
</section>

<section class="grid">
  <article>
    <h2>Edit Role</h2>
    <form
      hx-patch="{{ api_prefix }}/roles/{{ role.id }}"
      hx-target="#role-result"
      hx-swap="innerHTML"
      hx-headers='{"X-CSRF-Token": "{{ perms_csrf }}"}'
    >
      <label>
        Name
        <input type="text" name="name" value="{{ role.name }}" required>
      </label>
      <label>
        Description
        <textarea name="description" rows="2">{{ role.description or '' }}</textarea>
      </label>
      <button type="submit">Save</button>
    </form>
    <div id="role-result"></div>
  </article>

  <article id="permissions-panel">
    <h2>Permissions</h2>
    <form
      hx-put="{{ api_prefix }}/roles/{{ role.id }}/perms"
      hx-target="#perms-result"
      hx-swap="innerHTML"
      hx-headers='{"X-CSRF-Token": "{{ perms_csrf }}"}'
      hx-on--htmx:afterRequest="if(event.detail.successful){window.location.reload();}"
    >
      <fieldset>
        <legend>Select Permissions</legend>
        <div class="grid">
          {% for perm in available_permissions %}
            <label>
              <input type="checkbox" name="permission_codes" value="{{ perm.code }}" {% if perm.code in current_permission_codes %}checked{% endif %}>
              {{ perm.code }}
            </label>
          {% else %}
            <p class="muted">No permissions defined yet.</p>
          {% endfor %}
        </div>
      </fieldset>
      <label>
        Add Custom Permission
        <input type="text" name="new_permission_code" placeholder="e.g. report:export">
      </label>
      <button type="submit">Update Permissions</button>
    </form>
    <div id="perms-result"></div>
  </article>
</section>

<section>
  <form
    hx-delete="{{ api_prefix }}/roles/{{ role.id }}"
    hx-target="#delete-result"
    hx-swap="innerHTML"
    hx-headers='{"X-CSRF-Token": "{{ perms_csrf }}"}'
    hx-on--htmx:afterRequest="if(event.detail.successful){window.location.href='/admin/roles';}"
  >
    <button type="submit" class="contrast">Delete Role</button>
  </form>
  <div id="delete-result"></div>
</section>
{% endblock %}
